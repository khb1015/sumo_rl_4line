<!DOCTYPE html>
<html lang="ko">
<head>
    
    <meta charset="UTF-8">
    <title>SUMO RL Traffic Control</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/chart.js"></script>
    <link rel="stylesheet" href="/static/css/style.css">

    <style>
        #simCanvas {
            border: 1px solid black;
            margin-top: 20px;
        }
        #controls button {
            margin-right: 10px;
        }
    </style>
</head>

<body>
    <h1>4ì°¨ì„  êµì°¨ë¡œ RL êµí†µ ì œì–´</h1>

    <h3>ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ</h3>
    <div>
        <label>ì‹œë‚˜ë¦¬ì˜¤:
            <select id="scenario_select">
                <option value="A">ì‹œë‚˜ë¦¬ì˜¤ A (ì•„ì¹¨â†‘ ì ì‹¬â†“ ì €ë…â†‘)</option>
                <option value="B">ì‹œë‚˜ë¦¬ì˜¤ B (ì ì‹¬ í˜¼ì¡)</option>
                <option value="C">ì‹œë‚˜ë¦¬ì˜¤ C (í•˜ë£¨ì¢…ì¼ ë‚®ìŒ)</option>
                <option value="D">ì‹œë‚˜ë¦¬ì˜¤ D (í•˜ë£¨ì¢…ì¼ ë†’ìŒ)</option>
                <option value="custom">ì‚¬ìš©ì ì •ì˜ (Custom)</option>
            </select>
        </label>
    </div>

    <!-- ì‚¬ìš©ì ì •ì˜ ì…ë ¥ ì˜ì—­ -->
    <div id="custom_scenario_box" style="display:none; margin-top:10px;">
        <h4>ì‚¬ìš©ì ì •ì˜ íŠ¸ë˜í”½ (spawn rate)</h4>

        <!-- ì‹œê°„ëŒ€ 0~300 -->
        <h5>ì‹œê°„ëŒ€ 0 ~ 300</h5>
        <label>ë™: <input class="custom-rate" data-period="0_300" data-node="4175105101" type="number" step="0.01" value="0.04"></label>
        <label>ë‚¨: <input class="custom-rate" data-period="0_300" data-node="8952652973" type="number" step="0.01" value="0.04"></label>
        <label>ì„œ: <input class="custom-rate" data-period="0_300" data-node="4177516258" type="number" step="0.01" value="0.04"></label>
        <label>ë¶: <input class="custom-rate" data-period="0_300" data-node="5120772423" type="number" step="0.01" value="0.04"></label>

        <!-- ì‹œê°„ëŒ€ 300~600 -->
        <h5>ì‹œê°„ëŒ€ 300 ~ 600</h5>
        <label>ë™: <input class="custom-rate" data-period="300_600" data-node="4175105101" type="number" step="0.01" value="0.04"></label>
        <label>ë‚¨: <input class="custom-rate" data-period="300_600" data-node="8952652973" type="number" step="0.01" value="0.04"></label>
        <label>ì„œ: <input class="custom-rate" data-period="300_600" data-node="4177516258" type="number" step="0.01" value="0.04"></label>
        <label>ë¶: <input class="custom-rate" data-period="300_600" data-node="5120772423" type="number" step="0.01" value="0.04"></label>

        <!-- ì‹œê°„ëŒ€ 600~900 -->
        <h5>ì‹œê°„ëŒ€ 600 ~ 900</h5>
        <label>ë™: <input class="custom-rate" data-period="600_900" data-node="4175105101" type="number" step="0.01" value="0.04"></label>
        <label>ë‚¨: <input class="custom-rate" data-period="600_900" data-node="8952652973" type="number" step="0.01" value="0.04"></label>
        <label>ì„œ: <input class="custom-rate" data-period="600_900" data-node="4177516258" type="number" step="0.01" value="0.04"></label>
        <label>ë¶: <input class="custom-rate" data-period="600_900" data-node="5120772423" type="number" step="0.01" value="0.04"></label>
    </div>

    
    <button id="runBtn" type="button">Run Simulation</button>

    <hr>
    <h2>ì´ ë³´ìƒ</h2>
    <div>
        <p>Baseline ì´ ë³´ìƒ: <span id="baseline_reward">-</span></p>
        <p>DQN ì´ ë³´ìƒ: <span id="dqn_reward">-</span></p>
        <p>PPO ì´ ë³´ìƒ: <span id="ppo_reward">-</span></p>
    </div>

    <hr>

    <h2>íƒ€ì„ìŠ¤í…ë³„ Reward ê·¸ë˜í”„</h2>
    <canvas id="rewardChart"></canvas>

    <hr>

    <h2>SUMO ì‹œê°í™” (Replay)</h2>

    <div id="controls">
        <button onclick="loadReplay('baseline')">Baseline ì¬ìƒ</button>
        <button onclick="loadReplay('dqn')">DQN ì¬ìƒ</button>
        <button onclick="loadReplay('ppo')">PPO ì¬ìƒ</button>
        <button onclick="pauseReplay()">ì¼ì‹œì •ì§€</button>
        <button onclick="resumeReplay()">ì¬ê°œ</button>
    </div>

    <canvas id="simCanvas" width="800" height="800"></canvas>

    <script>
    const canvas = document.getElementById("simCanvas");
    const ctx = canvas.getContext("2d");
    const roadImg = new Image();
    roadImg.src = "/static/road.png";  // íŒŒì¼ ê²½ë¡œ

    roadImg.onload = () => {
        roadWidth = roadImg.width;
        roadHeight = roadImg.height;

        bufferCanvas.width = roadWidth * scaleRoad;
        bufferCanvas.height = roadHeight * scaleRoad;

        bufferCtx.drawImage(
            roadImg,
            0, 0,
            bufferCanvas.width,
            bufferCanvas.height
        );
    };

    const bufferCanvas = document.createElement("canvas");
    const bufferCtx = bufferCanvas.getContext("2d");

    let scaleRoad = 1.0;   // ë„ë¡œ ì´ë¯¸ì§€ ì „ì²´ í¬ê¸° ì¡°ì ˆ



    // ì¬ìƒ ê´€ë ¨ ë³€ìˆ˜ë“¤
    let replayFrames = [];
    let replayIndex = 0;
    let playing = false;
    let speed = 1;   // 1x ì†ë„
    let worldMinX = 99999, worldMaxX = -99999;
    let worldMinY = 99999, worldMaxY = -99999;
    let scale = 1;

    document.getElementById("scenario_select").addEventListener("change", function() {
        const value = this.value;
        const box = document.getElementById("custom_scenario_box");
        
        if (value === "custom") box.style.display = "block";
        else box.style.display = "none";
    });

    // ëª¨ë¸ë³„ íŒŒì¼ fetch â†’ frames ì €ì¥
    async function loadReplay(model) {
        const res = await fetch(`/api/replay?model=${model}`);
        const data = await res.json();

        if (!data.frames) {
            alert("í•´ë‹¹ ëª¨ë¸ì˜ ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        replayFrames = data.frames;
        replayIndex = 0;
        playing = true;

        // ê¸°ì¡´ ì¢Œí‘œ ê³„ì‚° ë¶€ë¶„ ê·¸ëŒ€ë¡œ ìœ ì§€
        worldMinX = 99999; worldMaxX = -99999;
        worldMinY = 99999; worldMaxY = -99999;

        replayFrames.forEach(f => {
            f.vehicles.forEach(v => {
                if (v.x < worldMinX) worldMinX = v.x;
                if (v.x > worldMaxX) worldMaxX = v.x;
                if (v.y < worldMinY) worldMinY = v.y;
                if (v.y > worldMaxY) worldMaxY = v.y;
            });
        });

        const worldWidth = worldMaxX - worldMinX;
        const worldHeight = worldMaxY - worldMinY;

        scale = Math.min(800 / worldWidth, 800 / worldHeight);

        console.log("Loaded memory replay:", model, data);
    }


    function pauseReplay() {
        playing = false;
    }

    function resumeReplay() {
        if (replayFrames.length > 0) playing = true;
    }

    // --------------------------
    //  SUMO ì‹œê°í™” (í”„ë ˆì„ ê¸°ë°˜)
    // --------------------------
    function animate() {
        if (playing && replayFrames.length > 0) {
            const frame = replayFrames[replayIndex];

            drawFrame(frame);

            replayIndex += speed;
            if (replayIndex >= replayFrames.length) {
                replayIndex = replayFrames.length - 1;
                playing = false;
            }
        }

        requestAnimationFrame(animate);
    }
    animate();

    // --------------------------
    //  Canvas ë Œë”ë§
    // --------------------------
    function drawFrame(frame) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        drawRoads();

        if (frame) {
            drawTrafficLight(frame.tls);

            frame.vehicles.forEach(v => drawVehicle(v));
        }
    }

    // ë„ë¡œ ê·¸ë¦¬ê¸° (ê¸°ë³¸ ì˜ˆì‹œ)
    function drawRoads() {
        if (!roadImg.complete || bufferCanvas.width === 0) return;

        const cropSize = canvas.width; // 800

        const sx = bufferCanvas.width / 2 - cropSize / 2;
        const sy = bufferCanvas.height / 2 - cropSize / 2;

        ctx.drawImage(
            bufferCanvas,
            sx, sy, cropSize, cropSize,
            0, 0, cropSize, cropSize
        );
    }




    function drawTrafficLight(tls_phase) {
        ctx.fillStyle = (tls_phase % 2 === 0 ? "green" : "red");
        ctx.beginPath();
        ctx.arc(390, 390, 15, 0, Math.PI * 2);
        ctx.fill();
    }

    function drawVehicle(v) {
    ctx.save();

    // ğŸ”¥ ìˆ˜ë™ ìœ„ì¹˜ ë³´ì •ê°’ (ë§ˆìŒê» ë°”ê¿”ë„ ë¨)
    const offsetX = -190;   // â†’ Canvasì—ì„œ ì˜¤ë¥¸ìª½/ì™¼ìª½ ì´ë™
    const offsetY = -50;   // â†’ Canvasì—ì„œ ìœ„/ì•„ë˜ ì´ë™

    // SUMO â†’ Canvas ë³€í™˜
    const cx = (v.x - worldMinX) * scale + offsetX;
    const cy = 800 - (v.y - worldMinY) * scale + offsetY;

    ctx.translate(cx, cy);
    ctx.rotate((v.angle - 90) * Math.PI / 180);

    ctx.fillStyle = "blue";
    ctx.fillRect(-5, -10, 10, 20);

    ctx.restore();
}



    </script>

</body>
</html>
